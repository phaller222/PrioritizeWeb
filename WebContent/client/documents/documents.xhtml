<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions">

<h:body>
	<ui:composition template="../templates/main.xhtml">
		<ui:define name="content">

			<p:outputPanel id="sessionok" rendered="#{loginBean.getLoggedIn()}">

				<h1>Documents</h1>
				<h:form id="documentTree">
					<p:tree id="documenttree" styleClass="border" value="#{documentBean.documentTree}"
						var="document" style="width:1100px;min-height:400px;">
						<f:facet name="header">
            Document Viewer
                    </f:facet>

						<p:treeNode styleClass="no-border">
							<f:metadata>
								<f:event type="preRenderView"
									listener="#{documentBean.updateDocumentTree()}" />
							</f:metadata>
							<p:dataTable styleClass="hide-column-names"
								value="document.documentInfo" var="info"
								rendered="#{document.leaf}" style="width:1000px;padding:0">
								<p:column styleClass="yellowtouch">
									<h:outputText value="#{document.name}"
										rendered="#{not document.leaf}" style="min-width:200px;" />
									<p:commandLink id="downloadLink"
										value="#{document.documentInfo.currentDocument.name}"
										ajax="false"
										disabled="#{!documentBean.canRead(document.documentInfo)}"
										rendered="#{document.leaf}"
										actionListener="#{documentBean.prepDownload(document.documentInfo.id)}"
										style="font-size:5em;width:120px;">
										<p:fileDownload value="#{documentBean.download}"
											contentDisposition="attachment" />
									</p:commandLink>
								</p:column>
								<p:column styleClass="yellowtouch" style="width:80px"
									headerText="Version" resizable="true">
									<h:outputText
										value="Version: #{document.documentInfo.currentDocument.version}"
										rendered="#{documentBean.canRead(document.documentInfo)}" />
								</p:column>
								<p:spacer width="20"></p:spacer>
								<p:column styleClass="yellowtouch" style="width:100px;">
									<h:outputText
										value="#{document.documentInfo.currentDocument.lastModified}"
										rendered="#{documentBean.canRead(document.documentInfo)}">
										<f:convertDateTime pattern="dd-MM-yyyy HH:MM" />
									</h:outputText>
								</p:column>
								<p:spacer width="20"></p:spacer>
								<p:column styleClass="yellowtouch" headerText="Last modified by"
									resizable="true" style="width:100px">
									<h:outputText
										value="#{document.documentInfo.currentDocument.lastModifiedBy.name}"
										rendered="#{documentBean.canRead(document.documentInfo)}" />
								</p:column>
								<p:spacer width="20"></p:spacer>
								<p:column styleClass="yellowtouch" headerText="Changes"
									resizable="true" style="width:180px;">
									<h:outputText
										value="#{document.documentInfo.currentDocument.changes}"
										rendered="#{documentBean.canRead(document.documentInfo)}"
										title="#{document.documentInfo.currentDocument.changes}" />
								</p:column>
								<p:column styleClass="yellowtouch" headerText="History"
									resizable="true" style="width:30px" width="30">
									<p:commandButton id="cmdhistory"
										disabled="#{!documentBean.canRead(document.documentInfo)}"
										action="#{documentBean.history(document.documentInfo)}"
										style="width:30px" icon="ui-icon-clock" title="History..."
										ajax="false" rendered="#{document.leaf}"></p:commandButton>
								</p:column>
								<p:spacer width="5"></p:spacer>
								<p:column styleClass="yellowtouch" headerText="Edit"
									resizable="true" style="width:30px">
									<p:commandButton
										action="#{documentBean.edit(document.documentInfo)}"
										disabled="#{!documentBean.canUpdate(document.documentInfo)}"
										rendered="#{document.leaf}" ajax="false" style="width:30px"
										title="Edit..." icon="ui-icon-pencil"></p:commandButton>
								</p:column>
								<p:spacer width="5"></p:spacer>
								<p:column styleClass="yellowtouch" headerText="Delete"
									resizable="true" style="width:30px">
									<p:commandButton id="cmddelete"
										action="#{documentBean.delete(document.documentInfo)}"
										style="width:30px" title="Delete"
										disabled="#{!documentBean.canDelete(document.documentInfo)}"
										rendered="#{document.leaf}" icon="ui-icon-trash" ajax="false"></p:commandButton>
								</p:column>
								<p:spacer width="20"></p:spacer>
							</p:dataTable>
							<h:outputText value="#{document.name}"
								rendered="#{not document.leaf}" />
						</p:treeNode>
						<p:ajax event="expand" listener="#{documentBean.nodeExpand}" />
						<p:ajax event="collapse" listener="#{documentBean.nodeCollapse}" />

					</p:tree>
					
					  <p:contextMenu for="documenttree">
                            <p:menuitem value="New Document" update="documenttree" actionListener="#{documentBean.createNewDocument}" icon="ui-icon-plus" />
           
                       </p:contextMenu>
					
					<!--  <p:poll interval="20" listener="#{documentBean.updateDocumentTree()}"   autoStart="true"/> -->
				</h:form>
			</p:outputPanel>

		</ui:define>
	</ui:composition>
</h:body>

</html>
